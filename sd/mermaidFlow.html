<html>
  <head>
    <style>
      .radioSpan {
        display: inline-flex;
        width: 180px;
      }

      .mmTitle {
        margin-left: 10%;
        font-size: 20px;
      }

      #L-sdc-payroll-0:hover {
        stroke: green!important;
        stroke-width:5px!important;
      }

    </style>
  </head>
  <body>

    <p>Please select the type of offering:</p>
      <input type="radio" name="offering" id="gro" value="gro"><label for="gro">local solution</label><br>
      <input type="radio" name="offering" id="flo" value="flo"><label for="flo">FLO</label><br>
      <input type="radio" name="offering" id="pro" value="pro" checked><label for="pro">PRO</label><br>
    
    <p><span class="radioSpan">Include Protime</span>
      <input type="radio" name="protime" id="pt-y" value="y" checked><label for="pt-y">Yes</label>
      <input type="radio" name="protime" id="pt-n" value="n"><label for="pt-n">No</label>
    </p>

    <p><span class="radioSpan">Data enrichment</span>
      <input type="radio" name="enrich" id="ri-y" value="y" checked><label for="ri-y">Yes</label>
      <input type="radio" name="enrich" id="ri-n" value="n"><label for="ri-n">No</label>
    </p>

    <p><span class="radioSpan">Point-to-point interface</span>
      <input type="radio" name="p2p" id="p2p-y" value="y"><label for="p2p-y">Yes</label>
      <input type="radio" name="p2p" id="p2p-n" value="n" checked><label for="p2p-n">No</label>
    </p>

    <p">country &nbsp; &nbsp;<input type="text" id="country" name="country"></p>

    <h3>Map payroll output</h3>

    <p><span class="radioSpan">GL Posting goes to</span>
      <input type="radio" name="gl" id="gl-mft"   value="mft"><label for="gl-mft">MFT</label>
      <input type="radio" name="gl" id="gl-mysp2" value="mysp2"><label for="gl-mysp2">My Service Point</label>
      <input type="radio" name="gl" id="gl-mysd"  value="mysd"><label for="gl-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">SEPA goes to</span>
      <input type="radio" name="sepa" id="sepa-mft" value="mft"><label for="sepa-mft">MFT</label>
      <input type="radio" name="sepa" id="sepa-mysp2" value="mysp2"><label for="sepa-mysp2">My Service Point</label>
      <input type="radio" name="sepa" id="sepa-mysd" value="mysd"><label for="sepa-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Payslips goes to</span>
      <input type="radio" name="slip" id="slip-mft" value="mft"><label for="slip-mft">MFT</label>
      <input type="radio" name="slip" id="slip-mysp2" value="mysp2"><label for="slip-mysp2">My Service Point</label>
      <input type="radio" name="slip" id="slip-mysd" value="mysd" checked><label for="slip-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Calculated data goes to</span>
      <input type="radio" name="calc" id="calc-mft" value="mft"><label for="calc-mft">MFT</label>
      <input type="radio" name="calc" id="calc-mysp2" value="mysp2"><label for="calc-mysp2">My Service Point</label>
      <input type="radio" name="calc" id="calc-mysd" value="mysd"><label for="calc-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Reporting goes to</span>
      <input type="radio" name="rep" id="rep-mft" value="mft"><label for="rep-mft">MFT</label>
      <input type="radio" name="rep" id="rep-mysp2" value="mysp2"><label for="rep-mysp2">My Service Point</label>
      <input type="radio" name="rep" id="rep-mysd" value="mysd"><label for="rep-mysd">sd Worx Portal</label>
    </p>

    <br>
    <button style="margin: 10px; color: white; background-color: silver;" onclick="$mm.renderDiagram('mm-id');">render</button>

    <div id="mm-id" style = "border:3px solid silver"></div>

    <br>
    <p>to do :</p>
    <ul>
      <li>dynamic textx: p2p, erp, lpe..
      <li>hover
    </ul>

    <br>
    <a href="https://mermaid.js.org/syntax/flowchart.html" target="_blank">Mermaid flowchart documentation</a>

    <script>

      const getJSON = async url => {
        const response = await fetch(url);
        return response.json(); // get JSON from the response 
      }

      function setLinkTo( nameRadio, nameNode = nameRadio) {
        let selector = 'input[name="' + nameRadio + '"]:checked',
            ele = document.querySelector(selector);
        
        if ( ele) {
          $mm.links.find( r => r.from == nameNode).to = ele.value;
          $mm.links.find( r => r.from == nameNode).visible = true;

          $mm.links.find( r => r.to   == nameNode).visible = true;

        } else {
          // hide the related links (1 from, 1 to)
          $mm.links.find( r => r.from == nameNode).visible = false;
          $mm.links.find( r => r.to   == nameNode).visible = false;
        }
      }
      
      getJSON( './mm/_mm_config.json')
      .then( data => {
        $mm = data;
        // console.log($mm);
      });
      
      function prepareMarkdown () {

        let offering = document.querySelector('input[name="offering"]:checked').value;
        
        let protime = document.querySelector('input[name="protime"]:checked').value == 'y' ? 'protime' : 'noProtime';

        let enrich = document.querySelector('input[name="enrich"]:checked').value == 'y' ? 'enrich' : 'noEnrich';

        let point2p = document.querySelector('input[name="p2p"]:checked').value == 'y' ? 'p2p' : 'noP2p';

        // set payroll output destinations
        setLinkTo( 'gl');
        setLinkTo( 'sepa');
        setLinkTo( 'rep', 'reporting');
        setLinkTo( 'slip', 'payslips');
        setLinkTo( 'calc');

        return sdMarkdown( offering, protime, enrich, point2p);
      }

      function sdMarkdown( pOffering, pProtime, pEnrich, pPoint2p) {

        let mmMarkdown = '';
                
        mmMarkdown += 'flowchart LR \n ';

        let nodes = {};
        
        // add all links for the offering
        for ( let i = 0; i < $mm.links.length; i++) {
          let li = $mm.links[i];
          //console.log(pOffering, li.groups.indexOf(pOffering));
          if (li.groups.indexOf(pOffering) >= 0 || $mm.showAll) {

            if ( li.extraCondition === undefined
              || li.extraCondition == pProtime
              || li.extraCondition == pEnrich
              || li.extraCondition == pPoint2p
              || $mm.showAll) {
              
              if ( !('visible' in li ) || li.visible) {

                mmMarkdown =  mmMarkdown + li.from + ' ' 
                          + li.link + (li.linkTxt ? '|' + li.linkTxt + '|' : '') + ' ' 
                          + li.to + ' \n ';

                // add to the nodes dictionary, and increment if key already exists.
                nodes[li.from] = (nodes[li.from] + 1) || 1;
                nodes[li.to] = (nodes[li.to] + 1) || 1;
              }

            }
          }
        }
        //console.log( nodes);

        // add fixed subgraph for payroll output
        mmMarkdown += 'subgraph out ["payroll output"]\n mysd \n mysp2 \n mft \n end \n';

        // add subgraph of hr input systems, with subgraph in subgraph (fixed) for myServicePoint
        mmMarkdown += 'subgraph hris ["  "]\n subgraph mysp ["my ServicePoint  "]\n cases \n unstruct \n end \n';
        if ( nodes['erp'] || $mm.showAll) {
          mmMarkdown += 'erp \n ';
        }
        
        if ( nodes['sdwp'] || $mm.showAll) {
          mmMarkdown += 'sdwp \n '
        }

        if ( nodes['protime'] || $mm.showAll) { 
          mmMarkdown += 'protime \n ';
        }

        if ( nodes['p2p'] || $mm.showAll) { 
          mmMarkdown += 'p2p \n ';
        }
        // to do: 4 times the same construct, functionize

        mmMarkdown += 'end \n ';

        // add node make up to the graph, when the node was part of a previous link
        for (const [key, value] of Object.entries(nodes)) {
          //console.log(key, value);
          if ($mm.nodes[key]) {
            mmMarkdown += key + $mm.nodes[key] + '\n';
          }
        }

        //mmMarkdown += 'click hr "https://www.sdworx.com" "svg title<br><i>italic html</i>" _blank\n';
        //mmMarkdown += 'click mft whateverFunction "svg title on callback"\n';

        console.log( '== start markdown mermaid ==');
        console.log( mmMarkdown);
        console.log( '== end markdown mermaid ==');

        return mmMarkdown;
      }

      let injectSvg = (mermaidSvg, idHtml) => {
        
        let diaParent = document.getElementById( idHtml);
        diaParent.innerHTML = '';

        // set title in h4, under idHtml
        // no title in Mermaid used, since then it becomes the hover text of each item.
        let country = document.querySelector('input[name="country"]').value,
            offering = document.querySelector('input[name="offering"]:checked').value;

        if (country) {
          let p = document.createElement("h4");
          p.innerHTML = [offering, 'flow', 'for', country].join( ' ');
          p.classList.add('mmTitle');
          diaParent.appendChild(p);
        }

        // inject the Mermaid svg in html element under idHtml.
        let dia = document.createElement("div");
        dia.innerHTML = mermaidSvg;
        diaParent.appendChild(dia);
      };
    </script>

    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.0.2/+esm';
      mermaid.initialize({ startOnLoad: false});

      $mm.renderDiagram = async function (idHtml) { 
        const { svg } = await mermaid.render('sd', prepareMarkdown());
        injectSvg( svg, idHtml);
      }
      
    </script>

  </body>
</html>
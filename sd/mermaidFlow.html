<html>
  <head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js"></script>

    <style>
      .mmTitle {
        margin-left: 10%;
        font-size: 20px;
      }
      #L-sdc-payroll-0:hover {
        stroke: green!important;
        stroke-width:5px!important;
      }
    </style>
  </head>
  <body>

    <p>Please select the type of offering:</p>
      <input type="radio" name="offering" id="gro" value="gro">
      <label for="gro">local solution</label><br>
      <input type="radio" name="offering" id="flo" value="flo">
      <label for="flo">FLO</label><br>
      <input type="radio" name="offering" id="pro" value="pro" checked>
      <label for="pro">PRO</label><br>
    
    <p>Include Protime :
      <input type="radio" name="protime" id="pt-y" value="y">
      <label for="pt-y">Yes</label>
      <input type="radio" name="protime" id="pt-n" value="n" checked>
      <label for="pt-n">No</label>
    </p>

    <p>Data enrichment :
      <input type="radio" name="enrich" id="ri-y" value="y" checked>
      <label for="ri-y">Yes</label>
      <input type="radio" name="enrich" id="ri-n" value="n">
      <label for="ri-n">No</label>
    </p>

    <p>country &nbsp; <input type="text" id="country" name="country"></p>
    

    <br>
    <ul>
      <li>gro: p2p</li>
      <li>styling in general
      <li>link T&A too long, recheck doc for alternative syntax</li>
      <li>hover & click behavior _blank (check in latest version)</li>
      <li>payroll output mapping
      <li>save svg: export to svg or png, or just screenshot it?</li>
      <li>country flag?</li>
      <li>lpe name?</li>
      <li>upgrade to version 10, via import construction</li>
    </ul>

    <br>
    <button style="margin: 10px; color: white; background-color: silver;" onclick="renderDiagram();">render</button>

    <div id="mm-id" style = "border:3px solid silver"></div>

    <br>
    <a href="https://stackoverflow.com/questions/65212332/how-to-render-a-mermaid-flowchart-dynamically" target="_blank">thanks, stackoverflow</a>

    <script>
      if (typeof ii == 'undefined') {
        ii = {};
      }
      ii.mermaid = {};
      ii.mermaid.showAll = false;
      
      mmLinks = [
        { "from": "hr",        "to": "erp",       "link": "-.->",       "groups": ['flo']},
        { "from": "hr",        "to": "sdwp",      "link": "-->" ,       "groups": ['pro']},
        { "from": "hr",        "to": "sdwp",      "link": "-->" ,       "groups": ['flo'],               "extraCondition": "enrich"},
        { "from": "hr",        "to": "protime",   "link": "-->" ,       "groups": ['gro', 'flo', 'pro'], "extraCondition": "protime"},
        { "from": "hr",        "to": "unstruct",  "link": "-->" ,       "groups": ['gro', 'flo', 'pro']},
        { "from": "erp",       "to": "sdc",       "link": "==>" ,       "groups": ['flo']},
        { "from": "sdwp",      "to": "sdc",       "link": "-->" ,       "groups": ['pro']},
        { "from": "sdwp",      "to": "sdc",       "link": "-->" ,       "groups": ['flo'],               "extraCondition": "enrich"},
        { "from": "protime",   "to": "sdc",       "link": "-- T&A -->", "groups": ['flo', 'pro'],        "extraCondition": "protime"},
        { "from": "protime",   "to": "payroll",   "link": "-- T&A -->", "groups": ['gro'],               "extraCondition": "protime"},
        { "from": "unstruct",  "to": "payroll",   "link": "-...->",     "groups": ['gro', 'flo', 'pro']},
        { "from": "sdc",       "to": "payroll",   "link": "==>",        "groups": ['flo', 'pro']},
        { "from": "payroll",   "to": "gl",        "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "sepa",      "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "reporting", "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "payslips",  "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "calc",      "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        // to do : set to dynamically
        { "from": "gl",        "to": "mft",       "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "sepa",      "to": "mft",       "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "reporting", "to": "mysp2",     "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "payslips",  "to": "mysd",      "link": "-->",        "groups": ['gro', 'flo', 'pro']},
        { "from": "calc",      "to": "mysp2",     "link": "-->",        "groups": ['gro', 'flo', 'pro']}
      ];

      mmNodes = [];
      mmNodes['hr']       = "(fa:fa-user hr<br/>input)";
      mmNodes['sdc']      = "((sd connect<br>fa:fa-plug<br>))";
      mmNodes['payroll']  = "{payroll}";
      mmNodes['unstruct'] = "(fa:fa-table<br>unstructured<br/>data)";
      mmNodes['calc']     = "(calculated<br/>data)";
      mmNodes['erp']      = "((workday))";
      mmNodes['sdwp']     = "[[SD Worx<br/>People<br>fa:fa-users]]";
      mmNodes['protime']  = "{protime<br>fa:fa-calendar-check}";
      mmNodes['cases']    = "(fa:fa-headphones case<br/>handling)";
      mmNodes['mysp2']    = "(fa:fa-file<br>my<br>ServicePoint)";
      mmNodes['mysd']     = "(fa:fa-mobile<br>mySdWorx<br>portal)";
      mmNodes['mft']      = "(fa:fa-external-link<br>mft)";
      mmNodes['gl']       = "{<img src='https://iconscout.com/ms-icon-310x310.png' width='40' height='40'><br>GL}";
      
      function sdMarkdown( pOffering, pProtime, pEnrich) {

        let mmMarkdown = '';
                
        mmMarkdown += 'flowchart LR \n ';

        let nodes = {},
            hasProtime = false,
            hasEnrichment = false;
        
        // add all links for the offering
        for ( let i = 0; i < mmLinks.length; i++) {
          let li = mmLinks[i];
          //console.log(pOffering, li.groups.indexOf(pOffering));
          if (li.groups.indexOf(pOffering) >= 0 || ii.mermaid.showAll) {
            if (li.extraCondition === undefined || li.extraCondition == pProtime || li.extraCondition == pEnrich || ii.mermaid.showAll) {
              
              mmMarkdown =  mmMarkdown + li.from + ' ' + li.link + ' ' + li.to + ' \n ';

              // add to the nodes dictionary, and increment if key already exists.
              nodes[li.from] = (nodes[li.from] + 1) || 1;
              nodes[li.to] = (nodes[li.to] + 1) || 1;

              if ( li.from == pProtime || li.to == pProtime) {
                hasProtime = true;
                console.log('protime tagged');
              }
            }
          }
        }
        console.log( nodes);

        // add fixed subgraph for payroll output
        mmMarkdown += 'subgraph out ["payroll output"]\n mysd \n mysp2 \n mft \n end \n';

        // add subgraph of hr input systems, with subgraph in subgraph (fixed) for myServicePoint
        mmMarkdown += 'subgraph hris ["  "]\n subgraph mysp ["my ServicePoint  "]\n cases \n unstruct \n end \n';
        if (pOffering == 'flo' || ii.mermaid.showAll) {
          mmMarkdown += 'erp \n ';
        }
        
        if ( (pOffering == 'flo' && pEnrich == 'enrich') || pOffering == 'pro'  || ii.mermaid.showAll) {
          mmMarkdown += 'sdwp \n '
        }

        if ( hasProtime || ii.mermaid.showAll) { 
          mmMarkdown += 'protime \n ';
        }

        mmMarkdown += 'end \n ';

        // add node make up to the graph, when the node was part of a previous link
        for (const [key, value] of Object.entries(nodes)) {
          //console.log(key, value);
          if (mmNodes[key]) {
            mmMarkdown += key + mmNodes[key] + '\n';
          }
        }

        mmMarkdown += 'click hr "https://www.sdworx.com" "appelboom" _blank\n';
        mmMarkdown += 'click sdc "https://www.sdworx.com" "appelboom2" _blank\n';

        console.log( mmMarkdown);

        return mmMarkdown;
      }


      function renderDiagram () { 
        
        let offering = document.querySelector('input[name="offering"]:checked').value;
        
        let protime = document.querySelector('input[name="protime"]:checked').value == 'y' ? 'protime' : 'noProtime';

        let enrich = document.querySelector('input[name="enrich"]:checked').value == 'y' ? 'enrich' : 'noEnrich';

        let markDown = sdMarkdown( offering, protime, enrich);
        
        let injectSvg = (mermaidSvg) => {
          let diaParent = document.getElementById("mm-id");
          diaParent.innerHTML = '';

          let country = document.querySelector('input[name="country"]').value;

          if (country) {
            let p = document.createElement("p");
            p.innerHTML = [offering, 'flow', 'for', country].join( ' ');
            p.classList.add('mmTitle');
            diaParent.appendChild(p);
          }

          let dia = document.createElement("div");
          dia.innerHTML = mermaidSvg;
          diaParent.appendChild(dia);
        };

        /*
          The core of this api is the render function that 
          given a graph definition as markdown
          renders the graph/diagram and returns a svg element for the graph. 
          It is is then up to the user of the API to make use of the svg, either insert it somewhere in the page or something completely different.
          Here the callback inserts the resulting svg in the page.
          The id (1st parameter) "sd" becomes the id of the resulting svg (id='sd' & #sd{font-family:"trebuchet ms", ..)
          Can become usefull in CSS selectors, for example.
        */
        mermaid.render( "sd", markDown, injectSvg);
      }
      
    </script>
  </body>
</html>
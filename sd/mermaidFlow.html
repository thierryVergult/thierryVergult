<html>
  <head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <style>
      .radioSpan {
        display: inline-flex;
        width: 180px;
      }

      .mmTitle {
        margin-left: 10%;
        font-size: 20px;
      }
      #L-sdc-payroll-0:hover {
        stroke: green!important;
        stroke-width:5px!important;
      }
    </style>
  </head>
  <body>

    <p>Please select the type of offering:</p>
      <input type="radio" name="offering" id="gro" value="gro"><label for="gro">local solution</label><br>
      <input type="radio" name="offering" id="flo" value="flo"><label for="flo">FLO</label><br>
      <input type="radio" name="offering" id="pro" value="pro" checked><label for="pro">PRO</label><br>
    
    <p><span class="radioSpan">Include Protime</span>
      <input type="radio" name="protime" id="pt-y" value="y" checked><label for="pt-y">Yes</label>
      <input type="radio" name="protime" id="pt-n" value="n"><label for="pt-n">No</label>
    </p>

    <p><span class="radioSpan">Data enrichment</span>
      <input type="radio" name="enrich" id="ri-y" value="y" checked><label for="ri-y">Yes</label>
      <input type="radio" name="enrich" id="ri-n" value="n"><label for="ri-n">No</label>
    </p>

    <p><span class="radioSpan">Point-to-point interface</span>
      <input type="radio" name="p2p" id="p2p-y" value="y"><label for="p2p-y">Yes</label>
      <input type="radio" name="p2p" id="p2p-n" value="n" checked><label for="p2p-n">No</label>
    </p>

    <p">country &nbsp; &nbsp;<input type="text" id="country" name="country"></p>

    <h3>Map payroll output</h3>

    <p><span class="radioSpan">GL Posting goes to</span>
      <input type="radio" name="gl" id="gl-mft"   value="mft" checked><label for="gl-mft">MFT</label>
      <input type="radio" name="gl" id="gl-mysp2" value="mysp2"><label for="gl-mysp2">My Service Point</label>
      <input type="radio" name="gl" id="gl-mysd"  value="mysd"><label for="gl-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">SEPA goes to</span>
      <input type="radio" name="sepa" id="sepa-mft" value="mft" checked><label for="sepa-mft">MFT</label>
      <input type="radio" name="sepa" id="sepa-mysp2" value="mysp2"><label for="sepa-mysp2">My Service Point</label>
      <input type="radio" name="sepa" id="sepa-mysd" value="mysd"><label for="sepa-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Payslips goes to</span>
      <input type="radio" name="slip" id="slip-mft" value="mft"><label for="slip-mft">MFT</label>
      <input type="radio" name="slip" id="slip-mysp2" value="mysp2"><label for="slip-mysp2">My Service Point</label>
      <input type="radio" name="slip" id="slip-mysd" value="mysd" checked><label for="slip-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Calculated data goes to</span>
      <input type="radio" name="calc" id="calc-mft" value="mft"><label for="calc-mft">MFT</label>
      <input type="radio" name="calc" id="calc-mysp2" value="mysp2"><label for="calc-mysp2">My Service Point</label>
      <input type="radio" name="calc" id="calc-mysd" value="mysd"><label for="calc-mysd">sd Worx Portal</label>
    </p>

    <p><span class="radioSpan">Reporting goes to</span>
      <input type="radio" name="rep" id="rep-mft" value="mft"><label for="rep-mft">MFT</label>
      <input type="radio" name="rep" id="rep-mysp2" value="mysp2" checked><label for="rep-mysp2">My Service Point</label>
      <input type="radio" name="rep" id="rep-mysd" value="mysd"><label for="rep-mysd">sd Worx Portal</label>
    </p>

    <br>
    <button style="margin: 10px; color: white; background-color: silver;" onclick="$mm.renderDiagram();">render</button>

    <div id="mm-id" style = "border:3px solid silver"></div>

    <br>
    <p>to do :</p>
    <ul>
      <li>review code after upgrade to version 10 : import esm construction</li>
      <li>make config more generic and more configurable : $mm</li>
      <li>styling in general
      <li>icons, even the sd svg ones colored previously</li>
      <li>hover functionality. Is supposed to work via click, includes url & hover (seems to work in start mode)</li>
      <li>p2p dynamic text, same for erp, now hardcoded workday</li>
      <li>lpe name?</li>
      <li>save svg: export to svg or png, or just screenshot it?</li>
    </ul>

    <br>
    <a href="https://mermaid.js.org/syntax/flowchart.html" target="_blank">Mermaid flowchart documentation</a>

    <script>
      $mm = {};
      $mm.showAll = false;
      
      mmLinks = [
        { "from": "hr",        "to": "erp",       "link": "-.->",   "groups": ['flo']},
        { "from": "hr",        "to": "sdwp",      "link": "-->" ,   "groups": ['pro']},
        { "from": "hr",        "to": "sdwp",      "link": "-->" ,   "groups": ['flo'],               "extraCondition": "enrich"},
        { "from": "hr",        "to": "protime",   "link": "-->" ,   "groups": ['gro', 'flo', 'pro'], "extraCondition": "protime"},
        { "from": "hr",        "to": "unstruct",  "link": "-->" ,   "groups": ['gro', 'flo', 'pro']},
        { "from": "hr",        "to": "p2p",       "link": "-->" ,   "groups": ['gro', 'flo', 'pro'], "extraCondition": "p2p"},
        { "from": "erp",       "to": "sdc",       "link": "==>" ,   "groups": ['flo']},
        { "from": "sdwp",      "to": "sdc",       "link": "-->" ,   "groups": ['pro']},
        { "from": "sdwp",      "to": "sdc",       "link": "-->" ,   "groups": ['flo'],               "extraCondition": "enrich"},
        { "from": "protime",   "to": "sdc",       "link": "-->" ,   "groups": ['flo', 'pro'],        "extraCondition": "protime",   "LinkTxt": "T&A"},
        { "from": "protime",   "to": "payroll",   "link": "-->" ,   "groups": ['gro'],               "extraCondition": "protime",   "linkTxt": "T&A"},
        { "from": "p2p",       "to": "sdc",       "link": "-->" ,   "groups": ['flo', 'pro'],        "extraCondition": "p2p"},
        { "from": "p2p",       "to": "payroll",   "link": "-->" ,   "groups": ['gro'],               "extraCondition": "p2p"},
        { "from": "unstruct",  "to": "payroll",   "link": "-...->", "groups": ['gro', 'flo', 'pro']},
        { "from": "sdc",       "to": "payroll",   "link": "==>",    "groups": ['flo', 'pro']},
        { "from": "payroll",   "to": "gl",        "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "sepa",      "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "reporting", "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "payslips",  "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "payroll",   "to": "calc",      "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        // to do : set to dynamically
        { "from": "gl",        "to": "mft",       "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "sepa",      "to": "mft",       "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "reporting", "to": "mysp2",     "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "payslips",  "to": "mysd",      "link": "-->",    "groups": ['gro', 'flo', 'pro']},
        { "from": "calc",      "to": "mysp2",     "link": "-->",    "groups": ['gro', 'flo', 'pro']}
      ];

      mmNodes = [];
      mmNodes['hr']       = "(<img src='./mm/sd-user.svg' width='60' height='60'><br>hr input)";
      mmNodes['sdc']      = "((sd connect<br>fa:fa-plug<br>))";
      mmNodes['payroll']  = "{<img src='./mm/sd-payroll-processing-plus-calendar.svg' width='60' height='60'><br>payroll}";
      mmNodes['unstruct'] = "(fa:fa-table<br>unstructured<br/>data)";
      mmNodes['calc']     = "(calculated<br/>data)";
      mmNodes['erp']      = "((workday))";
      mmNodes['sdwp']     = "[[SD Worx<br/>People<br>fa:fa-users]]";
      mmNodes['protime']  = "{protime<br>fa:fa-calendar-check}";
      mmNodes['cases']    = "(fa:fa-headphones case<br/>handling)";
      mmNodes['mysp2']    = "(fa:fa-file<br>my<br>ServicePoint)";
      mmNodes['mysd']     = "(fa:fa-mobile<br>mySdWorx<br>portal)";
      mmNodes['mft']      = "(fa:fa-external-link<br>mft)";
      mmNodes['gl']       = "{GL}";
      
      function prepareMarkdown () {

        let offering = document.querySelector('input[name="offering"]:checked').value;
        
        let protime = document.querySelector('input[name="protime"]:checked').value == 'y' ? 'protime' : 'noProtime';

        let enrich = document.querySelector('input[name="enrich"]:checked').value == 'y' ? 'enrich' : 'noEnrich';

        let point2p = document.querySelector('input[name="p2p"]:checked').value == 'y' ? 'p2p' : 'noP2p';

        // set payroll output destinations
        mmLinks.find( r => r.from == 'gl').to        = document.querySelector('input[name="gl"]:checked'  ).value;
        mmLinks.find( r => r.from == 'sepa').to      = document.querySelector('input[name="sepa"]:checked').value;
        mmLinks.find( r => r.from == 'reporting').to = document.querySelector('input[name="rep"]:checked' ).value;
        mmLinks.find( r => r.from == 'payslips').to  = document.querySelector('input[name="slip"]:checked').value;

        let calc = document.querySelector('input[name="calc"]:checked');
        if ( calc) {
          mmLinks.find( r => r.from == 'calc').to = calc.value;
          mmLinks.find( r => r.from == 'calc').visible = true;

          mmLinks.find( r => r.to   == 'calc').visible = true;
        } else {
          // hide the 2 calc links
          mmLinks.find( r => r.from == 'calc').visible = false;
          mmLinks.find( r => r.to   == 'calc').visible = false;
        }

        return sdMarkdown( offering, protime, enrich, point2p);
      }

      function sdMarkdown( pOffering, pProtime, pEnrich, pPoint2p) {

        let mmMarkdown = '';
                
        mmMarkdown += 'flowchart LR \n ';

        let nodes = {};
        
        // add all links for the offering
        for ( let i = 0; i < mmLinks.length; i++) {
          let li = mmLinks[i];
          //console.log(pOffering, li.groups.indexOf(pOffering));
          if (li.groups.indexOf(pOffering) >= 0 || $mm.showAll) {

            if ( li.extraCondition === undefined
              || li.extraCondition == pProtime
              || li.extraCondition == pEnrich
              || li.extraCondition == pPoint2p
              || $mm.showAll) {
              
              if ( !('visible' in li ) || li.visible) {

                mmMarkdown =  mmMarkdown + li.from + ' ' 
                          + li.link + (li.linkTxt ? '|' + li.linkTxt + '|' : '') + ' ' 
                          + li.to + ' \n ';

                // add to the nodes dictionary, and increment if key already exists.
                nodes[li.from] = (nodes[li.from] + 1) || 1;
                nodes[li.to] = (nodes[li.to] + 1) || 1;
              }

            }
          }
        }
        //console.log( nodes);

        // add fixed subgraph for payroll output
        mmMarkdown += 'subgraph out ["payroll output"]\n mysd \n mysp2 \n mft \n end \n';

        // add subgraph of hr input systems, with subgraph in subgraph (fixed) for myServicePoint
        mmMarkdown += 'subgraph hris ["  "]\n subgraph mysp ["my ServicePoint  "]\n cases \n unstruct \n end \n';
        if ( nodes['erp'] || $mm.showAll) {
          mmMarkdown += 'erp \n ';
        }
        
        if ( nodes['sdwp'] || $mm.showAll) {
          mmMarkdown += 'sdwp \n '
        }

        if ( nodes['protime'] || $mm.showAll) { 
          mmMarkdown += 'protime \n ';
        }

        if ( nodes['p2p'] || $mm.showAll) { 
          mmMarkdown += 'p2p \n ';
        }
        // to do: 4 times the same construct, functionize

        mmMarkdown += 'end \n ';

        // add node make up to the graph, when the node was part of a previous link
        for (const [key, value] of Object.entries(nodes)) {
          //console.log(key, value);
          if (mmNodes[key]) {
            mmMarkdown += key + mmNodes[key] + '\n';
          }
        }

        mmMarkdown += 'click hr "https://www.sdworx.com" "appelboom"\n';
        mmMarkdown += 'click sdc "https://www.sdworx.com" "appelboom2"\n';

        console.log( '== start markdown mermaid ==');
        console.log( mmMarkdown);
        console.log( '== end markdown mermaid ==');

        return mmMarkdown;
      }

      let injectSvg = (mermaidSvg) => {
        let diaParent = document.getElementById("mm-id");
        diaParent.innerHTML = '';

        let country = document.querySelector('input[name="country"]').value;

        if (country) {
          let p = document.createElement("p");
          p.innerHTML = [offering, 'flow', 'for', country].join( ' ');
          p.classList.add('mmTitle');
          diaParent.appendChild(p);
        }

        let dia = document.createElement("div");
        dia.innerHTML = mermaidSvg;
        diaParent.appendChild(dia);
      };
    </script>

    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.0.2/+esm';
      mermaid.initialize({ startOnLoad: false });

      $mm.renderDiagram = async function () { 
        const { svg } = await mermaid.render('sd', prepareMarkdown());
        injectSvg(svg);
      }
      
    </script>

  </body>
</html>
<!doctype html>
  <html lang=en>
  <head>
    <meta charset=utf-8>
    <title>vcr lab</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>

  <style>
    :root {
      --popay-blue: #0094b3;
    }

    popay {
      color: var(--popay-blue);
    }

    popay label {
      padding-right: 10px;
      display: inline-block; 
      width: 60px;
      text-align: right;
    }

    popay input {
      width: 80px;
      box-shadow: 0px 0px 3px var(--popay-blue);
      margin: 10px;
      text-align: right;
    }

    popay button {
      margin-top: 1em;
      margin-left: 1em;
      background-color: var(--popay-blue);
      color: white;
      font-weight: bold;
      height: 6em;
      width: 6em;
      border: none;
      box-shadow: 4px 4px 4px lightgray;
    }

    popay button:hover {
      box-shadow: 8px 8px 8px lightblue;
    }

    .row {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      width: 50%;
    }

    .column {
      display: flex;
      flex-direction: column;
      flex-basis: 100%;
      flex: 1;
    }

    .maand-row {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      margin-left: 1em;
    }

    .maand-col {
      flex: 1;
    }

    #vcrChart {
      width: 800px;
      height: 600px;
      margin: 0 auto;
    }
  </style>

  <script src="https://code.highcharts.com/highcharts.js"></script>
  
  <script>
    Highcharts.Renderer.prototype.symbols.maxLine = function( x, y, w, h) {
      return ['M', x + w / 2, y + h / 2, 'L', x + w, y + h / 2];
    };
  </script>

  <script>
    function show_vcr_highchart(p)
    {
        Highcharts.chart( p.id, {
        
        tooltip: {
          shared: true,
          formatter: function () {
            var colNr = this.points[1].point.index;
            
            svLoon = '<br/><span style="color:limegreen">sv loon:' + p.in[colNr] + '</span>';
                      
            premieOver = '<br/><span style="color:cadetblue">premie over:' + p.cPremie[colNr] + '</span>';
            
            var overMax = '';
            
            if ( p.cAbove[colNr] > 0 ) {
              overMax = '<br/><span style="color:crimson">' + p.cAbove[colNr] + ' boven max' + '</span>';
            }
            
            return '<b>' + this.x + '</b>'
                  + svLoon
                  + premieOver
                  + '<br/>cumulatief: ' + p.tot[colNr]
                  + overMax;
          },
          crosshairs: true // gives a nice vertical hover effect
        },

        title: {
          text: p.title
        },
            
        xAxis: {
          categories: [ 'jan', 'feb', 'mrt', 'apr', 'mei', 'jun']
        },
  
        yAxis: {
          title: {
            text: '€ (cumulatief)'
          },
          tickInterval: p.svMax,
          opposite: true,
          labels: {
            formatter: function () {
              return Highcharts.numberFormat( this.value, 2);
            },
            style: {
              color: 'crimson'
            }
          }
        },
        
        plotOptions: {
          column: {
            events: {
              legendItemClick: function () {
                return false;
              }
            }
          }
        },
        
        series: [  
          {
            name: 'sv loon',
            data: p.in,
            type: 'column',
            stacking: 'normal',
            color: 'limegreen',
            stack: 'stak left',
            dataLabels: { 
              enabled: true,
              inside: false,
              color: 'grey',
              x: -10,
              style: { textOutline: false }
            }
          },
          {
            name: 'cumulatief',
            data: p.cum,
            type: 'column',
            stacking: 'normal',
            color: 'khaki',
            stack: 'stak left',
            showInLegend: false,
          },
          {
            name: 'boven max',
            data: p.cAbove,
            type: 'column',
            stacking: 'normal',
            color: 'coral'
          }, 
          {
            name: 'premie over',
            data: p.cPremie,
            type: 'column',
            stacking: 'normal',
            color: 'cadetblue',
            dataLabels: { 
              enabled: true,
              inside: true,
              color: 'grey',
              x: +32,
              // 2 more configs to have the rightmost label also on the right of the bar
              overflow: 'allow',
              crop: false,
              style: { textOutline: false }
            }
          }, 
          {
            name: 'onder max',
            data: p.cPrev,
            type: 'column',
            stacking: 'normal',
            color: 'khaki',
            showInLegend: false
          },
          {
            name: 'sv max',
            data: p.max,
            type: 'scatter',
            enableMouseTracking: false,
            marker: {
              symbol: 'maxLine',
              lineWidth: 4,
              radius: 36,
              lineColor: 'crimson',
            }
          },
          {
            name: 'vorige max',
            data: p.prevMax,
            type: 'scatter',
            enableMouseTracking: false,
            showInLegend: false,
            marker: {
              symbol: 'maxLine',
              lineWidth: 2,
              radius: 36,
              lineColor: 'crimson',
            }
          }
        ]
      });
    }

    function prepare_vcr_data_and_show_chart () {
      popay.months = 6;

      popay.svMax = Number( document.getElementById("id_sv_max").value);
  
      popay.max = [];
  
      for ( var i = 0 ; i < popay.months ; i++) {
        popay.max[i] = popay.svMax * (i+1);
      }
  
      popay.in = [];
      popay.in[0] = Number( document.getElementById("id_m01").value);
      popay.in[1] = Number( document.getElementById("id_m02").value);
      popay.in[2] = Number( document.getElementById("id_m03").value);
      popay.in[3] = Number( document.getElementById("id_m04").value);
      popay.in[4] = Number( document.getElementById("id_m05").value);
      popay.in[5] = Number( document.getElementById("id_m06").value);
  
      popay.cum = [];
      popay.tot = [];
  
      popay.cum[-1] = 0;
      popay.in[-1] = 0;
  
      for ( var i = 0 ; i < popay.months ; i++) {
        popay.cum[i] = popay.cum[i-1] + popay.in[i-1];
        popay.tot[i] = popay.cum[i] + popay.in[i];
      }
  
      popay.cAbove = [];
      popay.cPrev = [];
      popay.cPremie = [];
  
      popay.cPremie[-1] = 0;
      popay.cAbove[-1] = 0;
      popay.cPrev[-1] = 0;
  
      for ( var i = 0 ; i < popay.months ; i++) {
        popay.cAbove[i] = Math.max( popay.tot[i] - popay.max[i], 0);
        
        var premie = popay.cAbove[i-1] + popay.in[i];
        popay.cPremie[i] = Math.min( premie, popay.max[i] - popay.cPremie[i-1] - popay.cPrev[i-1]);
        popay.cPrev[i] = popay.tot[i] - popay.cAbove[i] - popay.cPremie[i];
      }
  
      // array prevMax: contains the previous max
      // in case there was a max over in the previous month
  
      popay.prevMax = [];
  
      popay.prevMax[0] = null;
  
      for ( var i = 1 ; i < popay.months ; i++) {
        popay.prevMax[i] = null;
        if (popay.cAbove[i-1] > 0 ) {
          popay.prevMax[i] = popay.max[i-1];
        }
      }

      // round array values
      for ( var i = 0 ; i < popay.months ; i++) {
        popay.cPremie[i] = Math.round( popay.cPremie[i] * 100) / 100;
        popay.tot[i] = Math.round( popay.tot[i] * 100) / 100;
        popay.cAbove[i] = Math.round( popay.cAbove[i] * 100) / 100;
      }

      // set values on page
      document.getElementById('id_out_over_max').textContent = popay.cAbove[popay.months-1];
      document.getElementById('id_out_premie_over').textContent = popay.cPremie[popay.months-1];

      show_vcr_highchart( popay);

    }
  </script>


  <body>
    <popay>
      <h2>Voortschrijdend cumulatief rekenen</h2>

      <p style="margin-left:1em;">Voer het sv loon per maand op, en zet het (maandelijkse) maximum.</p>
      
      <div class='maand-row'>
          <div class='maand-col'><xlabel>jan</xlabel><input type="number" id="id_m01" min="0" value= "6000"></div>
          <div class='maand-col'><xlabel>feb</xlabel><input type="number" id="id_m02" min="0" value= "3000"></div>
          <div class='maand-col'><xlabel>mrt</xlabel><input type="number" id="id_m03" min="0" value="10000"></div>
          <div class='maand-col'><xlabel>apr</xlabel><input type="number" id="id_m04" min="0" value= "3000"></div>
          <div class='maand-col'><xlabel>mei</xlabel><input type="number" id="id_m05" min="0" value= "3000"></div>
          <div class='maand-col'><xlabel>jun</xlabel><input type="number" id="id_m06" min="0" value= "3000"></div>
      </div>

      <p>
        <label style='color: crimson;'>sv max</label><input type="number" id="id_sv_max" min="0" value="5000" style='box-shadow: 0px 0px 3px crimson;'>
      </p>

      <div class='row'>
        <div class='column'>
          <button onclick="prepare_vcr_data_and_show_chart();">Simuleer<br><br><i class="fa fa-line-chart fa-2x"></i></button>
        </div>
        <div class='column'>
          <div style="margin-top:20px;">premie over :&nbsp;<span id='id_out_premie_over'>_____.__</span>&nbsp;€</div>
          <div style="margin-top:20px;">over max :&nbsp;<span id='id_out_over_max'>____.__</span>&nbsp;€</div>
        </div>
      </div>

      <br>
      <div id="vcrChart"></div>
    </popay>

  </body>

  <script>
      var popay = {};

      popay.id = 'vcrChart';
      popay.title = null;

    </script>
</html>